<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Memory aspects in scientific coding | Konstantin Gregor </title> <meta name="author" content="Konstantin Gregor"> <meta name="description" content="When dealing with large data, memory (RAM) is often an issue."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://k-gregor.github.io/blog/2024/memory-aspects-in-scientific-coding/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Konstantin</span> Gregor </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/courses/">courses </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Memory aspects in scientific coding</h1> <p class="post-meta"> Created on November 17, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/code"> <i class="fa-solid fa-hashtag fa-sm"></i> code</a>     ·   <a href="/blog/category/code"> <i class="fa-solid fa-tag fa-sm"></i> code</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="introduction">Introduction</h1> <p>When we write scientific code, we often deal with large amounts of data and numerous data processing steps. Not rarely will we face out-of-memory errors, when the data gets too large for our RAM. Here are 5 tips on what to keep in mind when running into such problems.</p> <h1 id="tip-1-understanding-and-profiling">Tip 1: Understanding and Profiling</h1> <p>Before actually working on memory issues, we need to understand them fully. Technically, there are tools called <strong>profilers</strong> that help us with this which I will get into as well. But you can do some very simple things first do understand whether and how your memory is exploding.</p> <h2 id="print-statements">print statements</h2> <p>As a first simple step, add some print statements. This has two benefits: for one, you can see until which point your code actually runs. This already helps tremendously in figuring out what part of the code is making problems. The second benefit is that we can print out the variable sizes, giving us more details on what is currently happening in our memory. Note: Your coding environment (RStudio, DataSpell, …) will also give you options to execute code on a line-by-line basis, and can show you what’s currently stored in memory! Also make use of that. For me, however, I often need to get back to these raw tools, because a coding environment itself requires a lot of memory. So when I am dealing with memory issues, I usually exit the coding environment and run the code from the command line.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">corine_data</span> <span class="o">=</span> <span class="n">rxr</span><span class="p">.</span><span class="nf">open_rasterio</span><span class="p">(</span><span class="sh">'</span><span class="s">other_inputs/corine_data_full_mapped_classes.tif</span><span class="sh">'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>
<span class="n">pucher_data</span> <span class="o">=</span> <span class="n">rxr</span><span class="p">.</span><span class="nf">open_rasterio</span><span class="p">(</span><span class="sh">'</span><span class="s">/home/konni/Documents/phd/data/forest_age_pucher/agecl_1_perc.tif</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Memory usage of corine_data (approx): </span><span class="si">{</span><span class="n">corine_data</span><span class="p">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB</span><span class="sh">"</span><span class="p">)</span>

<span class="n">target_classes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">311</span><span class="p">,</span> <span class="mi">312</span><span class="p">,</span> <span class="mi">313</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">create mask</span><span class="sh">'</span><span class="p">)</span>
<span class="n">corine_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">corine_data</span><span class="p">.</span><span class="nf">isin</span><span class="p">(</span><span class="n">target_classes</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Memory usage of corine_mask (approx): </span><span class="si">{</span><span class="n">corine_mask</span><span class="p">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">reproject to get CORINE sums in Pucher resolution</span><span class="sh">'</span><span class="p">)</span>
<span class="n">class_count</span> <span class="o">=</span> <span class="n">corine_mask</span><span class="p">.</span><span class="n">rio</span><span class="p">.</span><span class="nf">reproject_match</span><span class="p">(</span><span class="n">match_data_array</span><span class="o">=</span><span class="n">pucher_data</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="p">.</span><span class="nb">sum</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Memory usage of class_count (approx): </span><span class="si">{</span><span class="n">class_count</span><span class="p">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">convert to float</span><span class="sh">'</span><span class="p">)</span>
<span class="n">class_count</span> <span class="o">=</span> <span class="n">class_count</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Memory usage of class_count after conversion to float (approx): </span><span class="si">{</span><span class="n">class_count</span><span class="p">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">divide</span><span class="sh">'</span><span class="p">)</span></code></pre></figure> <div class="caption"> This code was initially giving me OOM-errors (out of memory). As a first step, I simply added some print statements which helped me find the culprits. </div> <h2 id="htop-and-similar-tools-to-understand-memory-consumption">htop and similar tools to understand memory consumption</h2> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/htop-480.webp 480w,/assets/img/htop-800.webp 800w,/assets/img/htop-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/htop.png" class="img-fluid rounded z-depth-1 mx-auto d-block" width="400" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> Monitoring resource usage with `htop` </div> <p>htop is a command line tool that shows you the usage of your computer resources. It can show you your memory consumption per program, and also whether the memory is <strong>swapping</strong> (see the <em>Swp</em> line in the image above: 6GB of my swap was in use). This is the computer’s last resort and means that the memory is copied to disk. This keeps the computations alive but makes them extremely slow (often they then will never finish).</p> <p>So, htop (or alternatives) will help you understand what is happening, for instance, how fast the memory is blowing up. Together with the print statements, you can understand where your memory consumption is still in the boundary and when it gets too big. Furthermore, it shows you which other programs are currently taking up memory. As I mentioned previously, for computation-heavy code, I often close all other programs like web-browser, developer environment, and so on.</p> <h2 id="actual-profilers">Actual profilers</h2> <p>There are actually professional tools to do the profiling (= resource analysis) for you, and there are numerous options for each profiling language. Here, I want to show you <code class="language-plaintext highlighter-rouge">mprof</code> which works with Python. Installation and usage is super easy:</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">pip <span class="nb">install </span>memory-profiler
mprof run myscript.py
mprof plot</code></pre></figure> <p>That’s it! This will sample memory usage every 0.1 seconds and give you a plot on the memory performance like the one below. Together with some <code class="language-plaintext highlighter-rouge">print</code> statements will help you tremendously in understanding where the memory blows up.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blogpostimgs/mprof-480.webp 480w,/assets/img/blogpostimgs/mprof-800.webp 800w,/assets/img/blogpostimgs/mprof-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/blogpostimgs/mprof.png" class="img-fluid rounded z-depth-1 mx-auto d-block" width="400" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> Profilers like `mprof` give you full insights on resource usage of your script. </div> <h1 id="tip-2-reduce-the-amount-of-variables-stored-in-memory">Tip 2: Reduce the amount of variables stored in memory</h1> <p>A first simple way to reduce memory consumption is reducing the amount of stuff we’re keeping in memory. Scientific code often looks like this:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">dataset</span> <span class="o">=</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">dataset_converted</span> <span class="o">=</span> <span class="nf">convert</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">dataset_interpolated</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">dataset_converted</span><span class="p">)</span>
<span class="bp">...</span></code></pre></figure> <p>After the first three lines, do we really need to get back to the original <code class="language-plaintext highlighter-rouge">dataset</code> at any point? Probably not. But your software does not know that, so these variables stay in memory. In this case, you can simply override the original variables like so:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">dataset</span> <span class="o">=</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="nf">convert</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="bp">...</span></code></pre></figure> <p>This allows the programming language’s <strong>garbage collection</strong> processes to free up memory. Basically, they look for stuff in memory that surely cannot be used anymore in the code and free up this memory. In the updated example, the intermediate results do not need to be kept in memory and can be garbace collected.</p> <h1 id="tip-3-chunking">Tip 3: chunking</h1> <p>Often, your operations do not require knowledge about <em>all</em> data at all times. Check out the following code:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="n">rioxarray</span> <span class="k">as</span> <span class="n">rxr</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">rxr</span><span class="p">.</span><span class="nf">open_rasterio</span><span class="p">(</span><span class="sh">'</span><span class="s">myfile.tif</span><span class="sh">'</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">2</span></code></pre></figure> <p>The operation at one entry of the dataset needs no information from the rest of the dataset, right? So what we can do here is apply the operation on <strong>chunks</strong> instead of on the whole dataset at once. For that we can simply load the file in chunks like so:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="n">rioxarray</span> <span class="k">as</span> <span class="n">rxr</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">rxr</span><span class="p">.</span><span class="nf">open_rasterio</span><span class="p">(</span><span class="sh">'</span><span class="s">myfile.tif</span><span class="sh">'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">2</span></code></pre></figure> <p>I profiled these two code snippets using a roughly 5GB large random tif file, and the differences are tremendous! Without chunking, the script took 7 seconds and needed 13 GB of RAM. Adding chunking reduced the runtime to 1 second, and the memory usage to 200MB! The following image is the output of the <code class="language-plaintext highlighter-rouge">mprof</code> profiler. You can barely see the chunked run, it’s the blue line in the bottom left!</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blogpostimgs/memory_comparison_chunking-480.webp 480w,/assets/img/blogpostimgs/memory_comparison_chunking-800.webp 800w,/assets/img/blogpostimgs/memory_comparison_chunking-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/blogpostimgs/memory_comparison_chunking.png" class="img-fluid rounded z-depth-1 mx-auto d-block" width="400" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> Using chunking can tremendously reduce resource consumption of scripts. </div> <p>Other libraries have their own chunking options. So the tip here is to simply check whether there are options for chunking in the library that you’re using!</p> <h1 id="tip-4-data-types">Tip 4: Data types</h1> <p>An absolutely critical and extremely powerful aspect of memory efficiency is the way that the data is actually stored in memory. To understand this better, we need to dive a bit deeper into how that actually happens in the first place.</p> <h2 id="introduction-to-data-types">Introduction to data types</h2> <p>Depending on the programming language you use, you might be more or less familiar with data types. In Java or C++, for instance, you always need to make explicit which data type a certain variable has:</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">double</span> <span class="n">floatingPointNumber</span> <span class="o">=</span> <span class="mf">1.333</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">integerNumber</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">trueOrFalse</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">text</span> <span class="o">=</span> <span class="s">"hello"</span></code></pre></figure> <p>In those languages, you cannot assign anything to a variable that doesn’t adhere to the type:</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">text</span> <span class="o">=</span> <span class="mf">5.9</span><span class="o">;</span></code></pre></figure> <p>This will immediately cause an error because text is <code class="language-plaintext highlighter-rouge">String</code> but 5.9 is a <code class="language-plaintext highlighter-rouge">double</code> (floating point number with “double” precision). For some other situations, however, this works because the language immediately knows what’s supposed to happen:</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">floatingPointNumber</span> <span class="o">=</span> <span class="n">integerNumber</span><span class="o">;</span> <span class="c1">// automatically converts 5 to 5.0</span>
<span class="n">integerNumber</span> <span class="o">=</span> <span class="n">floatingPointNumber</span><span class="o">;</span> <span class="c1">// does not work and creates a compiler error</span></code></pre></figure> <p>But in many other languages, especially R and Python, this might not be obvious. In Python, for instance, you can happily assign anything to any variable:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">floatingPointNumber</span> <span class="o">=</span> <span class="mf">40.0</span>
<span class="n">floatingPointNumber</span> <span class="o">=</span> <span class="sh">'</span><span class="s">hello</span><span class="sh">'</span>
<span class="n">floatingPointNumber</span> <span class="o">=</span> <span class="bp">True</span></code></pre></figure> <p>Those languages will always doing their best in trying to understand what you’re trying to do, and you never really have to think about data types. But internally, every variable still has a data type and this is what we can look into when we have memory issues.</p> <h2 id="leveraging-data-types">Leveraging data types</h2> <p>So, even though you might not see it, all data is stored with some data type. And here is where a huge option for optimization lies. Let’s see first what these data types are.</p> <p>A classical number representation in programming is a 32bit <code class="language-plaintext highlighter-rouge">integer</code>. A variable of that type can hold every integer number between \(-2^{32}\) and \(2^{32}-1\). To allow for this large range, this variable needs 32 bits of storage, or 8 bytes. Let’s say your data array is 1000x1000 in size. This means, the raw data of that array without any other overhead is 1000x1000x8 = 8.000.000 bytes or ~7.6 Megabytes. That’s not a problem, but in many scientific problems, we need to deal with arrays of sizes like 100.000 x 10.000, so that will be already <em>~7.6 Gigabytes</em>!</p> <p>But do you really need the full range of values? Maybe you know your values are maximally up to 100 or so. In that case, you could store your array with <code class="language-plaintext highlighter-rouge">int8</code> (range: -128 to 127). This only needs 8 bits, or 1 byte. Then, the 100.000 x 10.000 array will only require 100.000 x 10.000 x 1 / 1024^2 = ~950 Megabytes! We just saved 6.5 Gigabytes of memory!</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>

<span class="n">memory_usage_in_bytes</span> <span class="o">=</span> <span class="n">array</span><span class="p">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">array_int8</span> <span class="o">=</span> <span class="n">array</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int8</span><span class="p">)</span>
<span class="n">converted_memory_usage_in_bytes</span> <span class="o">=</span> <span class="n">array_int8</span><span class="p">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">memory_usage_in_bytes</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">converted_memory_usage_in_bytes</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span></code></pre></figure> <p>The output of this will be the Megabytes that are needed to store these arrays: 7629.39 953.67, so we just saved over 6GB of RAM:</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blogpostimgs/memorytest-480.webp 480w,/assets/img/blogpostimgs/memorytest-800.webp 800w,/assets/img/blogpostimgs/memorytest-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/blogpostimgs/memorytest.png" class="img-fluid rounded z-depth-1 mx-auto d-block" width="400" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> Running the code from above shows the much lower memory usage when using `int8` instead of the regular `int32` </div> <h1 id="tip-5-lazy-loading">Tip 5: Lazy loading</h1> <p>Many data science libraries offer the option of <strong>lazy loading</strong>. This means that the data is only read when it is actually needed, and not read in full into memory where it can really blow up.</p> <p>The following line, reading a ~3GB data file, recently completely blew up on my machine with 32GB RAM:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="n">xarray</span> <span class="k">as</span> <span class="n">xr</span>
<span class="n">tas</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="nf">load_dataset</span><span class="p">(</span><span class="sh">'</span><span class="s">isimip_data/chelsa-w5e5_obsclim_tas_300arcsec_eu_daily_allyears_1979_2014_ncks.nc</span><span class="sh">'</span><span class="p">)</span></code></pre></figure> <p>In the end all I had to do was enable lazy loading, by simply replacing <code class="language-plaintext highlighter-rouge">load_dataset</code> with <code class="language-plaintext highlighter-rouge">open_dataset</code> and let the library do its magic:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">tas</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="nf">open_dataset</span><span class="p">(</span><span class="sh">'</span><span class="s">isimip_data/chelsa-w5e5_obsclim_tas_300arcsec_eu_daily_allyears_1979_2014_ncks.nc</span><span class="sh">'</span><span class="p">)</span></code></pre></figure> <p>My entire code then ran without needing more than 6GB of memory.</p> <p>Depending on your code and the libraries you use, there might be numerous ways in applying lazy loading. When you used some profiling to understand where things are blowing up, you can probably figure out whether this could help. In that case, you can simply ask ChatGPT explicitly how to make use of lazy loading within your code. However, it really depends on your code whether lazy loading will help you.</p> <h1 id="conclusion">Conclusion</h1> <p>Memory consumption is a complex issue. And today we often luckily have large enough machines to deal with the large data we work on. But still, we sometimes exceed this capacity. Hopefully the tips I mentioned can help you deal with this. To recap, here are things you need to do when you apparently have a memory issue in your program:</p> <ol> <li>Check where the issue is and how big it is by checking your computer’s memory usage and profiling the code</li> <li>Are there variables you can optimize away to minimize the stuff that is held in memory?</li> <li>Can you leverage what you know about the data? If you’re sure about the maximum value of a dataset, maybe specifying a small data type explicitly reduces the memory cost.</li> <li>Make use of chunking and lazy loading options.</li> </ol> <p>Hopefully this was helpful to you. If you would like to learn more about coding practices in science, please consider booking a course with me, <a href="/courses/">click here for more info</a></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/good-code-1-proper-naming-in-scientific-code/">Writing good code 1 - Naming, comments, functions, and the DRY principle</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/life-hacks-for-a-successful-phd/">9 life hacks for a successful PhD (or other knowledge work)</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/radiative-forcing/">A comprehensive explanation of radiative forcing and friends</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/good-code-2-solid-principles/">Writing good code 2 - the SOLID principles applied to scientific code</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Konstantin Gregor. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-12YX5QG8PE"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-12YX5QG8PE");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>